# Libraries
library(dplyr)
library(ggplot2)
# Load and process
NHANESraw <- read.csv("NHANESraw.csv")
# Filter and prepare
sleep_age <- NHANESraw %>%
filter(Age >= 16, !is.na(SleepHrsNight), !is.na(SleepTrouble)) %>%
mutate(
SleepTrouble = factor(SleepTrouble, levels = c("No","Yes")),
AgeGroup = cut(Age,
breaks = c(15, 24, 34, 44, 54, 64, 74, Inf),
labels = c("16–24","25–34","35–44","45–54","55–64","65–74","75+"),
right = TRUE
)
) %>%
group_by(AgeGroup, SleepTrouble) %>%
summarise(
mean_sleep = mean(SleepHrsNight, na.rm = TRUE),
se = sd(SleepHrsNight, na.rm = TRUE) / sqrt(n()),
lo = mean_sleep - 1.96 * se,
hi = mean_sleep + 1.96 * se,
.groups = "drop"
)
# Plot
ggplot(sleep_age, aes(x = AgeGroup, y = mean_sleep, color = SleepTrouble, group = SleepTrouble)) +
geom_line(linewidth = 1) +
geom_point(size = 2.8) +
geom_ribbon(aes(ymin = lo, ymax = hi, fill = SleepTrouble), alpha = 0.15, color = NA) +
scale_color_manual(values = c("No" = "#64B5F6", "Yes" = "#F48FB1")) +
scale_fill_manual(values = c("No" = "#64B5F6", "Yes" = "#F48FB1")) +
scale_y_continuous(
name = "Average Sleep Hours per Night",
breaks = seq(5.5, 8, 0.5),
labels = function(x) sprintf("%.1f", x)
) +
labs(
title = "Average Sleep Duration by Age and Reported Difficulty Sleeping",
subtitle = "Mean nightly sleep hours (±95% CI) by age group and reported sleep trouble (NHANES 2009–2011)",
x = "Age Group",
color = "Trouble Sleeping",
fill = "Trouble Sleeping"
) +
theme_minimal(base_size = 13) +
theme(
legend.position = "top",
panel.grid.minor = element_blank(),
plot.title.position = "plot"
)
# ============================================================
# Figure 2: Sleep Duration vs. Days of Poor Mental Health (Past 30 Days) per Age Group
# Script: Figure 2.R
# Author: Yianni Papagiannopoulos
# Modified: 2025-10-16
# ============================================================
# Libraries
library(dplyr)
library(ggplot2)
library(gridExtra)
# Load and process
NHANESraw <- read.csv("NHANESraw.csv")
df <- NHANESraw %>%
filter(Age >= 16, !is.na(SleepHrsNight), !is.na(DaysMentHlthBad)) %>%
mutate(
AgeGroup = cut(Age,
breaks = c(15, 24, 34, 44, 54, 64, 74, Inf),
labels = c("16–24","25–34","35–44","45–54","55–64","65–74","75+"),
right = TRUE
),
DaysMentHlthBad = pmin(pmax(DaysMentHlthBad, 0), 30)
)
# Spearman correlation per age group
stats_tbl <- df %>%
group_by(AgeGroup) %>%
summarise(
n   = n(),
rho = suppressWarnings(cor(SleepHrsNight, DaysMentHlthBad, method = "spearman")),
p   = suppressWarnings(cor.test(SleepHrsNight, DaysMentHlthBad, method = "spearman")$p.value),
.groups = "drop"
) %>%
mutate(
rho = round(rho, 2),
p   = ifelse(is.na(p), NA_character_,
ifelse(p < 0.001, "< 0.001", sprintf("%.3f", p)))
) %>%
rename(`Age Group` = AgeGroup, `ρ (Spearman)` = rho, `p-value` = p, `n` = n)
# Color palette
pal <- c("#1f77b4","#ff7f0e","#2ca02c","#d62728",
"#9467bd","#8c564b","#17becf")
# Scatter plot with LOESS
p_scatter <- ggplot(df, aes(SleepHrsNight, DaysMentHlthBad, color = AgeGroup)) +
geom_jitter(width = 0.05, height = 0.25, alpha = 0.18, size = 1) +
geom_smooth(method = "loess", se = TRUE, linewidth = 0.9, alpha = 0.10) +
scale_color_manual(values = pal, name = "Age Group") +
scale_x_continuous(limits = c(2, 12), breaks = 2:12) +
scale_y_continuous(limits = c(0, 30), breaks = seq(0, 30, 5)) +
labs(
title = "Sleep Duration vs. Days of Poor Mental Health (Past 30 Days)",
subtitle = "Scatter with LOESS fits by age group; table below lists Spearman ρ, p-values, and sample sizes (NHANES 2009–2011)",
x = "Sleep Hours per Night",
y = "Days of Poor Mental Health (0–30)"
) +
theme_minimal(base_size = 13) +
theme(
panel.grid.minor = element_blank(),
plot.title.position = "plot",
legend.position = "right"
)
# Create summary table (compact format)
tg <- tableGrob(
stats_tbl,
rows = NULL,
theme = ttheme_minimal(
core = list(fg_params = list(cex = 0.85)),
colhead = list(fg_params = list(fontface = 2, cex = 0.9)),
padding = unit(c(6, 3), "pt")
)
)
# Stack plot + table vertically
grid.arrange(p_scatter, tg, ncol = 1, heights = c(3, 0.8))
# ============================================================
# Figure 3.1: Reported Trouble Sleeping by Age Group (16+) & by Race
# Script: Figure 3(1).R
# Author: Madhavan Narkeeran, Yianni Papagiannopoulos
# Modified: 2025-10-16
# ============================================================
library(dplyr)
library(ggplot2)
library(forcats)
library(scales)
library(stringr)
# Load and process
NHANESraw <- read.csv("NHANESraw.csv")
# Keep 16+ and needed vars; drop NA SleepTrouble
base <- NHANESraw %>%
filter(Age >= 16, !is.na(SleepTrouble)) %>%
mutate(
SleepTrouble = factor(SleepTrouble, levels = c("No","Yes")),
AgeGroup = cut(
Age,
breaks = c(15, 24, 34, 44, 54, 64, 74, Inf),
labels = c("16–24","25–34","35–44","45–54","55–64","65–74","75+"),
right = TRUE
),
# --- MERGE Mexican into Hispanic ---
Race1 = trimws(as.character(Race1)),
RaceMerged = case_when(
str_detect(tolower(Race1), "mex")  ~ "Hispanic",
str_detect(tolower(Race1), "hisp") ~ "Hispanic",
TRUE                               ~ Race1
),
RaceMerged = fct_drop(RaceMerged)
)
# 95% Wald CI helper
add_prop_ci <- function(df, num, den) {
df %>%
mutate(
p_hat = {{num}} / {{den}},
se    = sqrt(p_hat * (1 - p_hat) / {{den}}),
lo    = pmax(0, p_hat - 1.96 * se),
hi    = pmin(1, p_hat + 1.96 * se)
)
}
# Summarize by RaceMerged x AgeGroup (across all genders)
race_age <- base %>%
filter(!is.na(RaceMerged)) %>%
group_by(AgeGroup, RaceMerged) %>%
summarise(
n_yes = sum(SleepTrouble == "Yes"),
n_tot = n(),
.groups = "drop"
) %>%
add_prop_ci(num = n_yes, den = n_tot)
# Order races by overall prevalence (avg across ages) for stable legend
race_levels <- race_age %>%
group_by(RaceMerged) %>% summarise(avg = mean(p_hat), .groups = "drop") %>%
arrange(desc(avg)) %>% pull(RaceMerged)
race_age <- race_age %>% mutate(RaceMerged = factor(RaceMerged, levels = race_levels))
pd <- position_dodge(width = 0.75)
ggplot(race_age, aes(x = AgeGroup, y = p_hat, fill = RaceMerged)) +
geom_col(position = pd, width = 0.65, color = "gray35") +
geom_errorbar(aes(ymin = lo, ymax = hi), position = pd, width = 0.24, color = "gray35") +
scale_y_continuous(labels = percent_format(accuracy = 1), limits = c(0, 1)) +
scale_fill_manual(
name = "Race / Ethnicity",
values = c(
"White"     = "#34eda6",  # light bluish
"Black"     = "#82ed40",  # soft green
"Hispanic"  = "#e89df5",  # light purple
"Asian"     = "#f6c177",  # soft yellow/orange
"Other"     = "#fa776e"   # light red/pink
)
) +
labs(
title = "Reported Trouble Sleeping by Age Group (16+): Race/Ethnicity",
subtitle = "Mexican merged into Hispanic. Bars show % reporting trouble sleeping; 95% CIs (NHANES 2009–2011)",
x = "Age Group",
y = "Proportion of Group"
) +
theme_minimal(base_size = 13) +
theme(
legend.position = "top",
legend.text = element_text(size = 10),
panel.grid.minor = element_blank(),
plot.title.position = "plot"
)
# ============================================================
# Figure 2: Sleep Duration vs. Days of Poor Mental Health (Past 30 Days) per Age Group
# Script: Figure 2.R
# Author: Yianni Papagiannopoulos
# Modified: 2025-10-16
# ============================================================
# Libraries
library(dplyr)
library(ggplot2)
library(gridExtra)
# Load and process
NHANESraw <- read.csv("NHANESraw.csv")
df <- NHANESraw %>%
filter(Age >= 16, !is.na(SleepHrsNight), !is.na(DaysMentHlthBad)) %>%
mutate(
AgeGroup = cut(Age,
breaks = c(15, 24, 34, 44, 54, 64, 74, Inf),
labels = c("16–24","25–34","35–44","45–54","55–64","65–74","75+"),
right = TRUE
),
DaysMentHlthBad = pmin(pmax(DaysMentHlthBad, 0), 30)
)
# Spearman correlation per age group
stats_tbl <- df %>%
group_by(AgeGroup) %>%
summarise(
n   = n(),
rho = suppressWarnings(cor(SleepHrsNight, DaysMentHlthBad, method = "spearman")),
p   = suppressWarnings(cor.test(SleepHrsNight, DaysMentHlthBad, method = "spearman")$p.value),
.groups = "drop"
) %>%
mutate(
rho = round(rho, 2),
p   = ifelse(is.na(p), NA_character_,
ifelse(p < 0.001, "< 0.001", sprintf("%.3f", p)))
) %>%
rename(`Age Group` = AgeGroup, `ρ (Spearman)` = rho, `p-value` = p, `n` = n)
# Color palette
pal <- c("#1f77b4","#ff7f0e","#2ca02c","#d62728",
"#9467bd","#8c564b","#17becf")
# Scatter plot with LOESS
p_scatter <- ggplot(df, aes(SleepHrsNight, DaysMentHlthBad, color = AgeGroup)) +
geom_jitter(width = 0.05, height = 0.25, alpha = 0.18, size = 1) +
geom_smooth(method = "loess", se = TRUE, linewidth = 0.9, alpha = 0.10) +
scale_color_manual(values = pal, name = "Age Group") +
scale_x_continuous(limits = c(2, 12), breaks = 2:12) +
scale_y_continuous(limits = c(0, 30), breaks = seq(0, 30, 5)) +
labs(
title = "Sleep Duration vs. Days of Poor Mental Health (Past 30 Days)",
subtitle = "Scatter with LOESS fits by age group; table below lists Spearman ρ, p-values, and sample sizes (NHANES 2009–2011)",
x = "Sleep Hours per Night",
y = "Days of Poor Mental Health (0–30)"
) +
theme_minimal(base_size = 13) +
theme(
panel.grid.minor = element_blank(),
plot.title.position = "plot",
legend.position = "right"
)
# Create summary table (compact format)
tg <- tableGrob(
stats_tbl,
rows = NULL,
theme = ttheme_minimal(
core = list(fg_params = list(cex = 0.85)),
colhead = list(fg_params = list(fontface = 2, cex = 0.9)),
padding = unit(c(6, 3), "pt")
)
)
# Stack plot + table vertically
grid.arrange(p_scatter, tg, ncol = 1, heights = c(3, 0.8))
# ============================================================
# Figure 3.1: Reported Trouble Sleeping by Age Group (16+) & by Race
# Script: Figure 3(1).R
# Author: Madhavan Narkeeran, Yianni Papagiannopoulos
# Modified: 2025-10-16
# ============================================================
library(dplyr)
library(ggplot2)
library(forcats)
library(scales)
library(stringr)
# Load and process
NHANESraw <- read.csv("NHANESraw.csv")
# Keep 16+ and needed vars; drop NA SleepTrouble
base <- NHANESraw %>%
filter(Age >= 16, !is.na(SleepTrouble)) %>%
mutate(
SleepTrouble = factor(SleepTrouble, levels = c("No","Yes")),
AgeGroup = cut(
Age,
breaks = c(15, 24, 34, 44, 54, 64, 74, Inf),
labels = c("16–24","25–34","35–44","45–54","55–64","65–74","75+"),
right = TRUE
),
# --- MERGE Mexican into Hispanic ---
Race1 = trimws(as.character(Race1)),
RaceMerged = case_when(
str_detect(tolower(Race1), "mex")  ~ "Hispanic",
str_detect(tolower(Race1), "hisp") ~ "Hispanic",
TRUE                               ~ Race1
),
RaceMerged = fct_drop(RaceMerged)
)
# 95% Wald CI helper
add_prop_ci <- function(df, num, den) {
df %>%
mutate(
p_hat = {{num}} / {{den}},
se    = sqrt(p_hat * (1 - p_hat) / {{den}}),
lo    = pmax(0, p_hat - 1.96 * se),
hi    = pmin(1, p_hat + 1.96 * se)
)
}
# Summarize by RaceMerged x AgeGroup (across all genders)
race_age <- base %>%
filter(!is.na(RaceMerged)) %>%
group_by(AgeGroup, RaceMerged) %>%
summarise(
n_yes = sum(SleepTrouble == "Yes"),
n_tot = n(),
.groups = "drop"
) %>%
add_prop_ci(num = n_yes, den = n_tot)
# Order races by overall prevalence (avg across ages) for stable legend
race_levels <- race_age %>%
group_by(RaceMerged) %>% summarise(avg = mean(p_hat), .groups = "drop") %>%
arrange(desc(avg)) %>% pull(RaceMerged)
race_age <- race_age %>% mutate(RaceMerged = factor(RaceMerged, levels = race_levels))
pd <- position_dodge(width = 0.75)
ggplot(race_age, aes(x = AgeGroup, y = p_hat, fill = RaceMerged)) +
geom_col(position = pd, width = 0.65, color = "gray35") +
geom_errorbar(aes(ymin = lo, ymax = hi), position = pd, width = 0.24, color = "gray35") +
scale_y_continuous(labels = percent_format(accuracy = 1), limits = c(0, 1)) +
scale_fill_manual(
name = "Race / Ethnicity",
values = c(
"White"     = "#34eda6",  # light bluish
"Black"     = "#82ed40",  # soft green
"Hispanic"  = "#e89df5",  # light purple
"Asian"     = "#f6c177",  # soft yellow/orange
"Other"     = "#fa776e"   # light red/pink
)
) +
labs(
title = "Reported Trouble Sleeping by Age Group (16+): Race/Ethnicity",
subtitle = "Mexican merged into Hispanic. Bars show % reporting trouble sleeping; 95% CIs (NHANES 2009–2011)",
x = "Age Group",
y = "Proportion of Group"
) +
theme_minimal(base_size = 13) +
theme(
legend.position = "top",
legend.text = element_text(size = 10),
panel.grid.minor = element_blank(),
plot.title.position = "plot"
)
# ============================================================
# Figure 8. Reported Sleep Trouble by Self-Reported General Health
# Script: Figure 8.R
# Author: Madhavan Narkeeran, Yianni Papagiannopoulos
# Modified: 2025-10-17
# ============================================================
library(dplyr)
library(ggplot2)
library(scales)
# Load and process
NHANESraw <- read.csv("NHANESraw.csv")
# Normalize HealthGen values (map 'Vgood' -> 'Very good') ---
df_health <- NHANESraw %>%
mutate(
HealthGen = trimws(HealthGen),
HealthGen = dplyr::recode(
HealthGen,
"Vgood" = "Very good",
"Verygood" = "Very good",
"very good" = "Very good"
),
HealthGen = factor(
HealthGen,
levels = c("Excellent", "Very good", "Good", "Fair", "Poor"),
ordered = TRUE
),
SleepTrouble = factor(SleepTrouble, levels = c("No", "Yes"))
) %>%
filter(!is.na(HealthGen), !is.na(SleepTrouble))
# Summaries (prop + Wald 95% CI) ---
sum_health <- df_health %>%
group_by(HealthGen) %>%
summarise(
n_yes   = sum(SleepTrouble == "Yes"),
n_total = n(),
prop_yes = n_yes / n_total,
se = sqrt(prop_yes * (1 - prop_yes) / n_total),
lo = pmax(0, prop_yes - 1.96 * se),
hi = pmin(1, prop_yes + 1.96 * se),
.groups = "drop"
) %>%
arrange(HealthGen)
# --- Cochran–Armitage trend test ---
scores <- seq_len(nrow(sum_health))
trend  <- prop.trend.test(x = sum_health$n_yes, n = sum_health$n_total, score = scores)
trend_p <- if (trend$p.value < 0.001) "p < 0.001" else sprintf("p = %.3f", trend$p.value)
# --- Color palette ---
fills <- c("#DDEAF7", "#C6DDF2", "#AFCFED", "#8DBAE5", "#6AA5DD")
# --- Polished plot ---
ggplot(sum_health, aes(x = HealthGen, y = prop_yes, fill = HealthGen)) +
geom_col(width = 0.55, color = NA) +
geom_errorbar(aes(ymin = lo, ymax = hi),
width = 0.1, color = "grey30", linewidth = 0.6) +
# percentages slightly above each bar
geom_text(
aes(label = percent(prop_yes, accuracy = 1)),
vjust = -3,
size = 3.6,
fontface = "bold",
color = "grey20"
) +
scale_fill_manual(values = c("#DDEAF7", "#C6DDF2", "#AFCFED", "#8DBAE5", "#6AA5DD"), guide = "none") +
scale_y_continuous(
labels = percent_format(accuracy = 1),
breaks = seq(0, 0.6, 0.1),
expand = expansion(mult = c(0, 0.05))
) +
coord_cartesian(ylim = c(0, 0.60), clip = "off") +   # ← decreased to 60%
labs(
title = "Reported Sleep Trouble by Self-Reported General Health (NHANES 2009–2011)",
subtitle = paste0("Bars show % reporting sleep trouble; 95% CIs. Cochran–Armitage trend test: ", trend_p),
x = "Self-Reported General Health",
y = "Percent Reporting Sleep Trouble"
) +
theme_minimal(base_size = 13) +
theme(
panel.grid.minor = element_blank(),
panel.grid.major.x = element_blank(),
panel.grid.major.y = element_line(color = "grey88"),
plot.title.position = "plot",
axis.text.x = element_text(angle = 0, hjust = 0.5, vjust = 1, margin = margin(t = 6)),
plot.margin = margin(8, 20, 12, 12)
)
# ============================================================
# Figure 3.2: Reported Trouble Sleeping by Age Group (16+) & by Gender
# Script: Figure 3(2).R
# Author: Madhavan Narkeeran, Yianni Papagiannopoulos
# Modified: 2025-10-16
# ============================================================
library(dplyr)
library(ggplot2)
library(forcats)
library(scales)
# Load and process
NHANESraw <- read.csv("NHANESraw.csv")
# Keep 16+ and needed vars; drop NA SleepTrouble as requested
base <- NHANESraw %>%
filter(Age >= 16, !is.na(SleepTrouble)) %>%
mutate(
SleepTrouble = factor(SleepTrouble, levels = c("No","Yes")),
AgeGroup = cut(Age,
breaks = c(15, 24, 34, 44, 54, 64, 74, Inf),
labels = c("16–24","25–34","35–44","45–54","55–64","65–74","75+"),
right = TRUE
)
)
# small helper for normal-approx 95% CI (good for EDA)
add_prop_ci <- function(df, num, den) {
df %>%
mutate(
p_hat = {{num}} / {{den}},
se    = sqrt(p_hat * (1 - p_hat) / {{den}}),
lo    = pmax(0, p_hat - 1.96 * se),
hi    = pmin(1, p_hat + 1.96 * se)
)
}
# Uses `base` and add_prop_ci() you already defined
gender_age <- base %>%
filter(!is.na(Gender)) %>%
mutate(Gender = factor(Gender, levels = c("female","male"))) %>%
group_by(AgeGroup, Gender) %>%
summarise(
n_yes = sum(SleepTrouble == "Yes"),
n_tot = n(),
.groups = "drop"
) %>%
add_prop_ci(num = n_yes, den = n_tot)
pd <- position_dodge(width = 0.7)
ggplot(gender_age, aes(x = AgeGroup, y = p_hat, fill = Gender)) +
geom_col(position = pd, width = 0.6, color = "gray35") +
geom_errorbar(aes(ymin = lo, ymax = hi), position = pd, width = 0.22, color = "gray35") +
scale_y_continuous(labels = percent_format(accuracy = 1), limits = c(0, 1)) +
scale_fill_manual(
values = c("female" = "#F4A7B9", "male" = "#A7C7E7"),
labels = c("Female", "Male"),
name = NULL
) +
labs(
title = "Reported Trouble Sleeping by Age Group (16+): Female vs Male",
subtitle = "Bars show % reporting trouble sleeping; error bars are 95% CIs (NHANES 2009–2011)",
x = "Age Group",
y = "Proportion of Group"
) +
theme_minimal(base_size = 13) +
theme(
legend.position = "top",
panel.grid.minor = element_blank(),
plot.title.position = "plot"
)
